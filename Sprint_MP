# Sprint Mercado Pago (MP) – Sprint Plan

> Objetivo: dejar Mercado Pago completamente funcional end-to-end (tarjeta + Checkout Pro/Wallet), con webhooks robustos y checkout web conectado al backend existente.

Formato de estimación: `S` (~0,5 día), `M` (~1 día), `L` (~2 días).

---

## 1. Backend – Core de Mercado Pago

### MP-BE-01 – Configuración central de credenciales MP (`S`)
- **Archivos**:  
  - `apps/api/src/payments/payments.config.ts`  
  - `apps/api/src/app.module.ts`
- **Tareas**:  
  - Validar que `PaymentsConfigService` expone correctamente: `getMercadoPagoAccessToken`, `getMercadoPagoPublicKey`, `getMercadoPagoIntegratorId`, `getMercadoPagoWebhookSecret`, `getApiBaseUrl`, `getFrontendBaseUrl`.  
  - Revisar variables en `.env` / `.env.local` (raíz y `apps/api/.env`) para MP (Access Token, Public Key, Webhook secret).  
  - Agregar validaciones mínimas (throw en arranque si faltan secretos críticos en producción).  
- **Estado**: Listo (tests Jest backend `apps/api` en verde).

### MP-BE-02 – Creación de preferencias Checkout Pro / Wallet (`M`)
- **Archivos**:  
  - `apps/api/src/modules/payments/mercadopago/mercadopago.service.ts`  
  - `apps/api/src/modules/payments/mercadopago/mercadopago.controller.ts`
- **Tareas**:  
  - Revisar `createPreference(params: CreatePreferenceParams)` para:  
    - Usar `external_reference = order.id`.  
    - Llenar `items[]` usando `order.items` y `template.name`.  
    - Configurar `back_urls` a `/checkout/success?orderId=...&status=...`.  
    - Establecer `notification_url` al endpoint de webhook real.  
  - Asegurar que el controller `POST /payments/mercadopago/preference` sólo requiere `orderId` y opcionalmente `notificationUrl`.  
  - Guardar `preferenceId` en `payment.gatewayTransactionId` (si aplica) para trazabilidad.  
- **Estado**: Listo (tests Jest backend `apps/api` en verde).

### MP-BE-03 – Pago con tarjeta vía API de Payments (`M`)
- **Archivos**:  
  - `apps/api/src/payments/dto/process-payment.dto.ts`  
  - `apps/api/src/payments/payments.service.ts`
- **Tareas**:  
  - Amarrar `ProcessPaymentDto` para soportar claramente:  
    - `provider: 'mercadopago'` (único) y `method: 'card' | 'google_pay' | 'apple_pay' | 'spei' | 'oxxo'`.  
  - En `PaymentsService.processPayment`:  
    - Validar que la `Order` está en `PENDING` y dentro de ventana de reserva (`reservedUntil`).  
    - Preparar payload para `PaymentClient.create` (transaction_amount, token, payment_method_id, installments, payer.email/identification).  
    - Mapear respuesta MP → `PaymentStatus` y actualizar `Payment` + `Order` (no marcar `PAID` aquí, delegar a webhook).  
- **Estado**: Listo (tests Jest backend `apps/api` en verde).

### MP-BE-04 – Webhook único y robusto Mercado Pago (`L`)
- **Archivos**:  
  - `apps/api/src/payments/webhooks.controller.ts`  
  - `apps/api/src/payments/webhooks.service.ts`  
  - `apps/api/src/modules/legal/legal.service.ts`
- **Tareas**:  
  - En el controller `POST /webhooks/mercadopago`, recoger:  
    - `x-mp-signature` / `x-mercadopago-signature` / `x-signature` y `x-request-id`.  
  - En `PaymentsWebhooksService.handleMercadoPagoWebhook`:  
    - Verificar firma con `getMercadoPagoWebhookSecret()` y `requestId`.  
    - Obtener el payment real con `mpPaymentClient.get({ id })`.  
    - Mapear estados MP (`approved`, `in_process`, `pending`, `rejected`, `refunded`, `cancelled`) → `PaymentStatus` y estado de `Order`.  
    - Evitar reprocesar pagos ya en estado final (`COMPLETED` / `FAILED`).  
    - Crear `LegalLog` con action `PAYMENT_WEBHOOK`, metadatos (provider, paymentId, status, orderId).  
- **Estado**: Listo (tests Jest backend `apps/api` en verde).

### MP-BE-05 – Fulfillment y consistencia de tickets (`M`)
- **Archivos**:  
  - `apps/api/src/payments/order-fulfillment.processor.ts`  
  - `apps/api/src/modules/tickets/pdf-generator.service.ts`  
  - `apps/api/src/modules/email/email.service.ts`
- **Tareas**:  
  - Confirmar que `PaymentTasksService.enqueueOrderFulfillment(orderId)` se llama sólo cuando Payment pasa a `COMPLETED`.  
  - En el processor, garantizar:  
    - Tickets no se duplican si ya existen (check previo).  
    - `ticketTemplate.sold` y `quantity` se actualizan de forma consistente.  
  - Verificar que `EmailService` dispara el envío (o log simulado) de tickets con PDFs generados por `PdfGeneratorService`.  
- **Estado**: Listo (tests Jest backend `apps/api` en verde).

---

## 2. Frontend – Checkout & Bricks de Mercado Pago

### MP-FE-01 – Resumen de orden desde backend (`S`)
- **Archivos**:  
  - `apps/web/src/pages/checkout/Checkout.tsx`  
  - `apps/web/src/api/client.ts`
- **Tareas**:  
  - Tras `createCheckoutSession`, usar `getCheckoutOrder(orderId)` para poblar `CheckoutSummary`.  
  - Eliminar cualquier cálculo manual de totales en el cliente; confiar sólo en `CheckoutOrderSummary`.  
- **Estado**: Listo (tests Vitest frontend `apps/web` en verde).

### MP-FE-02 – Wallet / Checkout Pro (`M`)
- **Archivos**:  
  - `apps/web/src/features/payments/components/MercadoPagoButton.tsx`  
  - `apps/web/src/pages/checkout/Checkout.tsx`
- **Tareas**:  
  - Verificar que `MercadoPagoButton` llama a `createMercadoPagoPreference` (`/payments/mercadopago/preference`) con `orderId`.  
  - Usar el SDK MP (`MercadoPago.js` o `@mercadopago/sdk-react`) para renderizar el Wallet Brick con `preferenceId`.  
  - Asegurar que `back_urls` llevan a `CheckoutSuccess` con query `orderId` y `status`, y que la página lee esos parámetros para mostrar el mensaje correcto.  
- **Estado**: Listo (tests Vitest frontend `apps/web` en verde).

### MP-FE-03 – Pago con tarjeta (Card Payment Brick) (`M`)
- **Archivos**:  
  - `apps/web/src/components/payments/MercadoPagoCard.tsx`  
  - `apps/web/src/pages/checkout/Checkout.tsx`  
  - `apps/web/src/api/client.ts`
- **Tareas**:  
  - Integrar el Card Brick para obtener `token`, `paymentMethodId`, `issuerId`, `installments`.  
  - Enviar esos datos a `apiClient.createMercadoPagoPayment` (que golpea `/payments/pay`).  
  - Mostrar feedback inline:  
    - Aprobado → redirigir a `/checkout/success`.  
    - Rechazado → mostrar mensaje derivado de `status_detail`.  
    - Pendiente → instruir al usuario que espere confirmación por email.  
- **Estado**: Listo (tests Vitest frontend `apps/web` en verde).

### MP-FE-04 – UX de errores y estados (`S`)
- **Archivos**:  
  - `apps/web/src/pages/checkout/Checkout.tsx`  
  - `apps/web/src/pages/checkout/CheckoutSuccess.tsx`
- **Tareas**:  
  - Unificar manejo de errores en checkout (banner o toast) usando mensajes amigables según estado MP.  
  - En `CheckoutSuccess`, leer `orderId` + `status` de la URL y mostrar estados diferenciados: `completed | in_review | failed`.  
  - Añadir instrucciones claras para reenviar boletos / contacto (desde el correo de confirmación).  
- **Estado**: Listo (tests Vitest frontend `apps/web` en verde).

---

## 3. QA – Automatización y pruebas manuales

### MP-QA-01 – Unit tests backend pagos (`M`)
- **Archivos**:  
  - `apps/api/src/payments/payments.service.spec.ts`  
  - `apps/api/src/modules/payments/webhooks.service.spec.ts`
- **Tareas**:  
  - Mockear SDK MP para:  
    - Creación de pagos exitosos, fallidos, en proceso.  
    - Webhooks duplicados, firma inválida, payment inexistente.  
  - Verificar que se actualizan correctamente `Payment` y `Order`, y que se registran logs legales.  
- **Estado**: Listo (tests Jest backend `apps/api` en verde).

### MP-QA-02 – E2E sandbox de checkout (`L`)
- **Entorno**:  
  - Usar MP sandbox + base pequeña de datos en dev/staging.
- **Casos mínimos**:  
  - Tarjeta aprobada: compra un ticket → MP → retorno → orden `PAID`, tickets generados.  
  - Tarjeta rechazada: mensaje claro, orden sigue en `PENDING` / `FAILED` según diseño.  
  - Checkout Pro: flujo redirect + webhook confirmando.  
  - Simular retraso de webhook: que el sistema se mantenga consistente (no se marcan pagos sin confirmación).  
- **Implementación actual**:  
  - Tests Playwright en `apps/e2e` (`buyer-flow`, `organizer-flow`, `director-flow`) parametrizados con `RUN_E2E=true` para correr sólo en entornos con sandbox configurado.  
- **Estado**: Listo (infra de tests Playwright configurada y ejecutable con `RUN_E2E=true`; ejecución depende del entorno de QA/sandbox).

### MP-QA-03 – Checklist de producción (`S`)
- **Tareas** (según docs de MP y MCP):  
  - Verificar credenciales de producción de Mercado Pago cargadas en la plataforma (Vercel/Railway/etc.), usando **Access Token** y **Public Key** de producción (no sandbox).  
  - Configurar la URL pública del webhook en el panel de MP, apuntando al endpoint único `/api/webhooks/mercadopago` y validando su respuesta 200/201.  
  - Activar y probar notificaciones IPN/webhooks según la guía de Mercado Pago (pagos aprobados, pendientes y rechazados).  
  - Ejecutar 1–2 compras reales de bajo monto con tarjeta (Checkout Bricks / Checkout Pro) y validar toda la cadena: MP → webhook → orden `PAID` → tickets generados → email/logs.  
  - Documentar en QA qué usuario, evento y montos se usaron, y guardar los IDs de pago de MP para futuras auditorías.  
- **Estado**: Pendiente de ejecución en entorno de producción/sandbox real (checklist definida, requiere compras reales y validación manual).

---

## 4. Orden sugerido de ejecución

1. **MP-BE-01, MP-BE-02, MP-BE-03** – Core backend MP y preferencias.  
2. **MP-FE-01, MP-FE-02** – Checkout Pro/Wallet end-to-end.  
3. **MP-BE-04, MP-BE-05** – Webhooks y fulfillment idempotente.  
4. **MP-FE-03, MP-FE-04** – Card Brick + UX de errores.  
5. **MP-QA-01, MP-QA-02, MP-QA-03** – Tests y validación en sandbox/producción.

Con este archivo puedes usar los IDs (MP-BE-01, etc.) como issues en tu board y tener trazabilidad directa a los archivos donde se implementa cada tarea.

