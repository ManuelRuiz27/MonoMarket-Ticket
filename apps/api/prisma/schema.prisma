// This is your Prisma schema file,
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(ORGANIZER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizer Organizer?
  legalLogs LegalLog[]
  eventStaff EventStaff[]

  @@map("users")
}

model Organizer {
  id           String   @id @default(uuid())
  userId       String   @unique
  businessName String
  status       OrganizerStatus @default(ACTIVE)
  feePlanId    String?
  complementaryTicketsUsed Int @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  feePlan   FeePlan?        @relation(fields: [feePlanId], references: [id])
  events    Event[]
  templates TicketTemplate[]
  staffSessions StaffSession[]

  @@map("organizers")
}

model Event {
  id          String   @id @default(uuid())
  organizerId String
  title       String
  description String?  @db.Text
  category    String?
  venue       String?
  address     String?
  city        String?
  startDate   DateTime
  endDate     DateTime?
  coverImage  String?
  status      EventStatus @default(DRAFT)
  capacity    Int     @default(0)
  price       Decimal @default(0) @db.Decimal(10, 2)
  currency    String  @default("MXN")
  isPublic    Boolean @default(true)
  
  // Unlisted events (MVP)
  isUnlisted  Boolean @default(false)
  accessToken String? @unique
  maxTicketsPerPurchase Int @default(5)
  
  // Custom PDF Template
  pdfTemplatePath String?
  qrCodeX         Int?
  qrCodeY         Int?
  qrCodeWidth     Int?
  
  // Attendance tracking
  attendanceCount Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizer Organizer        @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  templates TicketTemplate[]
  orders    Order[]
  staff     EventStaff[]
  staffSessions StaffSession[]

  @@map("events")
}

model TicketTemplate {
  id          String   @id @default(uuid())
  organizerId String
  eventId     String?
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("MXN")
  quantity    Int
  sold        Int      @default(0)
  isComplimentary Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizer Organizer @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  event     Event?    @relation(fields: [eventId], references: [id], onDelete: SetNull)
  tickets   Ticket[]
  orderItems OrderItem[]

  @@map("ticket_templates")
}

model Buyer {
  id        String   @id @default(uuid())
  email     String
  name      String
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@map("buyers")
}

model Order {
  id        String      @id @default(uuid())
  eventId   String
  buyerId   String
  status    OrderStatus @default(PENDING)
  total     Decimal     @db.Decimal(10, 2)
  currency  String      @default("MXN")
  platformFeeAmount    Decimal @default(0) @db.Decimal(10, 2)
  organizerIncomeAmount Decimal @default(0) @db.Decimal(10, 2)
  
  // Legal compliance (MVP)
  ipAddress  String?
  userAgent  String?  @db.Text
  
  // Checkout reservation (MVP - 5 min lock)
  reservedUntil DateTime?
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  paidAt    DateTime?

  event    Event     @relation(fields: [eventId], references: [id])
  buyer    Buyer     @relation(fields: [buyerId], references: [id])
  tickets  Ticket[]
  payment  Payment?
  emailLogs EmailLog[]
  items    OrderItem[]

  @@map("orders")
}

model Payment {
  id                   String        @id @default(uuid())
  orderId              String        @unique
  gateway              PaymentGateway
  amount               Decimal       @db.Decimal(10, 2)
  currency             String        @default("MXN")
  status               PaymentStatus @default(PENDING)
  gatewayTransactionId String?
  paymentMethod        String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Ticket {
  id         String       @id @default(uuid())
  orderId    String
  templateId String
  qrCode     String       @unique
  status     TicketStatus @default(VALID)
  usedAt     DateTime?
  qrJwtHash  String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime @updatedAt

  order    Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  template TicketTemplate @relation(fields: [templateId], references: [id])

  @@map("tickets")
}

model StaffSession {
  id           String   @id @default(uuid())
  organizerId  String
  eventId      String
  tokenHash    String   @unique
  expiresAt    DateTime
  revoked      Boolean  @default(false)
  failedAttempts Int    @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organizer Organizer @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  event     Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@map("staff_sessions")
}

model EventStaff {
  id        String   @id @default(uuid())
  eventId   String
  userId    String
  role      String   @default("scanner")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_staff")
}

model FeePlan {
  id                        String   @id @default(uuid())
  name                      String
  description               String?  @db.Text
  platformFeePercent        Decimal  @db.Decimal(5, 2)
  platformFeeFixed          Decimal  @default(0) @db.Decimal(10, 2)
  paymentGatewayFeePercent  Decimal  @default(0) @db.Decimal(5, 2)
  complementaryFee          Decimal  @default(0) @db.Decimal(10, 2)
  isDefault                 Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  organizers Organizer[]

  @@map("fee_plans")
}

model LegalLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  ipAddress String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@map("legal_logs")
}

model EmailLog {
  id        String         @id @default(uuid())
  orderId   String?
  to        String
  subject   String
  status    EmailStatus    @default(PENDING)
  providerMessageId String?
  sentAt    DateTime?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  order Order? @relation(fields: [orderId], references: [id])

  @@map("email_logs")
}

model OrderItem {
  id         String   @id @default(uuid())
  orderId    String
  templateId String
  quantity   Int
  unitPrice  Decimal  @db.Decimal(10, 2)
  currency   String   @default("MXN")
  createdAt  DateTime @default(now())

  order    Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  template TicketTemplate @relation(fields: [templateId], references: [id])

  @@map("order_items")
}

model WebhookLog {
  id        String   @id @default(uuid())
  gateway   String
  event     String
  payload   Json
  signature String?
  verified  Boolean  @default(false)
  orderId   String?
  createdAt DateTime @default(now())

  @@map("webhook_logs")
}

// Enums
enum Role {
  ORGANIZER
  DIRECTOR
  ADMIN
  STAFF
}

enum OrganizerStatus {
  ACTIVE
  SUSPENDED
  BANNED
  APPROVED
  PENDING
  BLOCKED
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentGateway {
  OPENPAY
  MERCADOPAGO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum TicketStatus {
  VALID
  USED
  CANCELLED
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}
